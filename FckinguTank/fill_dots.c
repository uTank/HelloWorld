#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "base.h"

#define BYTE_PER_LINE    (40)
#define MAX_DOTS_LINE    (200)

#define DOTS_PER_LINE    (BYTE_PER_LINE * 8)
#define MAX_BYTE_LINE    ((MAX_DOTS_LINE + 7 ) / 8)


uchar dst_dot[MAX_DOTS_LINE][BYTE_PER_LINE];
uchar src_dot[MAX_BYTE_LINE][DOTS_PER_LINE];
uchar char_dot[][8] = {
    {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
    {0xaf, 0xaf, 0xaf, 0xaf, 0xaf, 0xaf, 0xaf, 0xaf},
    {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
    {0xa0, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0},
    {0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08},
    {0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x00},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
    {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
    {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
    {0x0f, 0x1f, 0x2f, 0x3f, 0x4f, 0x5f, 0x6f, 0x7f},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    {0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc},
    {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
    {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
};

/* 像素点为单位 */
void fill_char_to_dots(uchar (*dst)[BYTE_PER_LINE], int row, int col,
                       uchar *dots, int width, int height)
{
    int i, j, shift;
    uchar uctmp;
    uchar *tptr, *sptr, *dptr;

    shift = col % 8;
//    sptr = dots;
    dptr = (uchar *)dst + row * BYTE_PER_LINE + col / 8;

    for(i = 0; i < height; i++)
    {
        tptr = dptr;
        sptr = dots;
        for(j = 0; j < width && j < DOTS_PER_LINE - col; j += 8)
        {
            uctmp = *sptr++;
            if(j + 8 > width)
            {
                uctmp &= (0xff << (j + 8 - width));
            }
            *tptr++ |= (uctmp >> shift);
            if(j + 8 < DOTS_PER_LINE - col)
                *tptr |= (uctmp << (8 - shift));
        }
        dots += (width + 7) / 8;
        dptr += BYTE_PER_LINE;
    }
}

/* 像素点为单位 */
/* 横向高位从左到右, 纵向高位从上到下 */
void convert_dots(uchar (*src)[BYTE_PER_LINE], int row, int col, 
                  uchar (*dst)[DOTS_PER_LINE], int width, int height)
{
    int i, j, k;
    uchar *sptr, *dptr, *tptr;

    debug_msg(" width = %d, height = %d\n", width, height);
    debug_msg(" row = %d, col = %d\n", row, col);
    debug_msg(" src = %p, dst = %p\n", src, dst);

    sptr = (uchar *)src + row * BYTE_PER_LINE + col / 8;    

    for(i = 0; i < height; i++)
    {
        tptr = sptr;
        dptr =  (uchar *)dst + (i / 8) * DOTS_PER_LINE;
        debug_msg(" i = %.2d, sptr = %p, dptr = %p, *sptr = %.2x\n", i, sptr, dptr, *sptr);
        for(j = 0; j < width; j += 8)
        {
            for(k = 0; k < 8 && k < (width - j); k++)
            {
                if(*tptr & (1 << (7 - k)))
                    *dptr++ |= (1 << (7 - i % 8));
                else
                    *dptr++ &= ~(1 << (7 - i % 8));
            }
            tptr++;
        }
        sptr += BYTE_PER_LINE;
    }
}


int main(int argc, char *argv[])
{
    int i, j;

    debug_msg(" BYTE_PER_LINE = %d\n MAX_DOTS_LINE = %d\n"
              " DOTS_PER_LINE = %d\n MAX_BYTE_LINE = %d\n",
              BYTE_PER_LINE, MAX_DOTS_LINE, DOTS_PER_LINE, MAX_BYTE_LINE);

    fill_char_to_dots(dst_dot, 0, 0, char_dot, 64, 30);

    debug_msg("      ");
    for(j = 0; j < BYTE_PER_LINE; j++)
        debug_msg("%.2d ", j);
    debug_msg("\n");
    for(i = 0; i < 40; i++)
    {
        debug_msg("%.3d : ", i);
        for(j = 0; j < BYTE_PER_LINE; j++)
            debug_msg("%.2x ", dst_dot[i][j]);
        debug_msg("\n");
    }
    debug_msg("\n");

    convert_dots(dst_dot, 0, 0, src_dot, 10, 10);

    for(i = 0; i < 5; i++)
    {
        for(j = 0; j < 100; j++)
            debug_msg((j+1) % 40 ? "%.2x " : "%.2x\n", src_dot[i][j]);
        debug_msg(j % 40 ? "\n\n" : "\n");
    }
    return 0;
}

